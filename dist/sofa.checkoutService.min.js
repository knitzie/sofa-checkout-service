/**
 * sofa-checkout-service - v0.2.0 - 2014-03-31
 * http://www.sofa.io
 *
 * Copyright (c) 2013 CouchCommerce GmbH (http://www.couchcommerce.org) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA SDK (SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.CheckoutService",function(c,d,e,f,g){var h,i,j,k={},l={"Content-Type":"application/x-www-form-urlencoded"},m=g.get("checkoutUrl"),n=g.get("checkoutUrl")+"ajax.php",o=null;a.observable.mixin(k),k.createQuoteData=function(){var a=e.getItems().map(function(a){return{productID:a.product.id+"",qty:a.quantity,variantID:a.getVariantID(),optionID:a.getOptionID()}});return a};var p=function(b){if(!b)return null;var c=a.Util.clone(b),d={},f=function(b){b&&b.birthday&&b.birthmonth&&b.birthyear&&(b.birthdate=a.Util.zeroFill(b.birthyear,4)+"-"+a.Util.zeroFill(b.birthmonth.value,2)+"-"+a.Util.zeroFill(b.birthday,2),delete b.birthday,delete b.birthmonth,delete b.birthyear)};f(c.billingAddress),f(c.shippingAddress),c.billingAddress&&c.billingAddress.country&&(c.billingAddress.country=b.billingAddress.country.value,c.billingAddress.countryLabel=b.billingAddress.country.label,d.invoiceAddress=JSON.stringify(c.billingAddress)),c.shippingAddress&&c.shippingAddress.country&&(c.shippingAddress.country=b.shippingAddress.country.value,c.shippingAddress.countryLabel=b.shippingAddress.country.label,d.shippingAddress=JSON.stringify(c.shippingAddress)),d.paymentMethod=c.selectedPaymentMethod&&c.selectedPaymentMethod.method?c.selectedPaymentMethod.method:c.selectedPaymentMethod,c.selectedShippingMethod&&c.selectedShippingMethod.method&&(d.shippingMethod=c.selectedShippingMethod.method),d.quote=JSON.stringify(k.createQuoteData()),d.pseudocardpan=c.pseudocardpan,d.truncatedcardpan=c.truncatedcardpan;var g=e.getActiveCoupons().map(function(a){return a.code});return d.coupons=JSON.stringify(g),d};k.getLastUsedPaymentMethod=function(){return h||null},k.getLastUsedShippingMethod=function(){return i||null},k.getShippingMethodsForPayPal=function(a){var b={billingAddress:{country:a||g.getDefaultCountry()},shippingAddress:{country:a||g.getDefaultCountry()},selectedPaymentMethod:"paypal_express"};return k.getSupportedCheckoutMethods(b)},k.getSupportedCheckoutMethods=function(b){t(b);var e=p(b);return e.task="GETPAYMENTMETHODS",a.Util.isObject(b.selectedPaymentMethod)&&(h=b.selectedPaymentMethod),a.Util.isObject(b.selectedShippingMethod)&&(i=b.selectedShippingMethod),c({method:"POST",url:n,headers:l,transformRequest:cc.Util.toFormData,data:e}).then(function(b){var c=null;return b.data&&(c=a.Util.toJson(b.data),c&&(c.paymentMethods=c.paymentMethods.map(function(a){return a.surcharge=parseFloat(a.surcharge),a.surcharge_percentage&&(a.surcharge_percentage=parseFloat(a.surcharge_percentage)),a}),c.shippingMethods=c.shippingMethods.map(function(a){return a.price=parseFloat(a.price),a}))),c},function(a){return f.error(["[CheckoutService: getSupportedCheckoutMethods]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})},k.checkoutWithCouchCommerce=function(b){t(b),b.addressEqual&&(b.shippingAddress=b.billingAddress);var e=p(b);return e.task="CHECKOUT",c({method:"POST",url:n,headers:l,transformRequest:cc.Util.toFormData,data:e}).then(function(b){var c=null;return b.data&&(c=a.Util.toJson(b.data),c=c.token||null),c},function(a){return f.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})},k.checkoutWithPayPal=function(a,b){var e={selectedShippingMethod:a,selectedPaymentMethod:{method:"paypal"},shippingAddress:{country:b},billingAddress:{country:b}},h=p(e);return h.task="UPDATEQUOTEPP",c({method:"POST",url:n,headers:l,transformRequest:cc.Util.toFormData,data:h}).then(function(a){return 1!=a.data?d.reject(new Error("invalid server response")):void(window.location.href=g.get("checkoutUrl"))}).then(null,function(a){return f.error(["[CheckoutService: checkoutWithPayPal]","[Request Data]",h,"[Service answer]",a]),d.reject(a)})};var q=function(a){return a===b||null===a?"":a},r=function(a){a=a||{};var b={value:q(a.country),label:q(a.countryname)};return{company:q(a.company),salutation:q(a.salutation),surname:q(a.lastname),name:q(a.firstname),street:q(a.street),streetnumber:q(a.streetnumber),streetextra:q(a.streetextra),zip:q(a.zip),city:q(a.city),country:b.value?b:null,email:q(a.email),telephone:q(a.telephone)}},s=function(a){return a=a||{},{sum:q(a.subtotal),shipping:q(a.shipping),surcharge:q(a.surcharge),vat:q(a.vat),total:q(a.grandtotal)}};k.getSummary=function(b){return c({method:"POST",url:m+"summaryst.php",headers:l,transformRequest:cc.Util.toFormData,data:{details:"get",token:b}}).then(function(c){var d={};return d.response=a.Util.toJson(c.data),d.invoiceAddress=r(d.response.billing),d.shippingAddress=r(d.response.shipping),d.summary=s(d.response.totals),d.token=b,j=d,o=d.response.redirect?{token:b,redirect:d.response.redirect}:null,d})},k.getLastSummary=function(){return j},k.activateOrder=function(b){if(o&&o.token===b)throw window.location.href=g.get("checkoutUrl")+o.redirect+"?token="+b,"stop execution";return c({method:"POST",url:m+"docheckoutst.php",headers:l,transformRequest:cc.Util.toFormData,data:{details:"get",token:b}}).then(function(b){var c=a.Util.toJson(b.data);return c},function(a){return f.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})};var t=function(a){return a.addressEqual&&(a.shippingAddress=a.billingAddress),a};return k})}(sofa);