/**
 * sofa-checkout-service - v0.7.0 - 2014-12-03
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.CheckoutService",function(c,d,e,f,g,h,i){var j,k,l,m={},n={"Content-Type":"application/x-www-form-urlencoded"},o=g.get("checkoutUrl"),p=g.get("checkoutUrl")+"ajax.php",q="paymentMethod",r="shippingMethod",s=null;a.observable.mixin(m),m.createQuoteData=function(){var a=e.getItems().map(function(a){return{productID:a.product.id+"",qty:a.quantity,variantID:a.getVariantID(),optionID:a.getOptionID()}});return a};var t=function(b){if(!b)return null;var c=a.Util.clone(b);c.addressEqual&&a.Util.isEmpty(c.shippingAddress)?c.shippingAddress=a.Util.clone(c.billingAddress):c.addressEqual&&a.Util.isEmpty(c.billingAddress)&&(c.billingAddress=a.Util.clone(c.shippingAddress));var d={},f=function(b){b&&b.birthday&&b.birthmonth&&b.birthyear&&!b.birthdate&&(b.birthdate=a.utils.FormatUtils.zeroFill(b.birthyear,4)+"-"+a.utils.FormatUtils.zeroFill(b.birthmonth,2)+"-"+a.utils.FormatUtils.zeroFill(b.birthday,2),delete b.birthday,delete b.birthmonth,delete b.birthyear)};f(c.billingAddress),f(c.shippingAddress),c.billingAddress&&c.billingAddress.country&&(c.billingAddress.countryLabel=c.billingAddress.country.label,c.billingAddress.country=c.billingAddress.country.value,d.invoiceAddress=JSON.stringify(c.billingAddress)),c.shippingAddress&&c.shippingAddress.country&&(c.shippingAddress.countryLabel=c.shippingAddress.country.label,c.shippingAddress.country=c.shippingAddress.country.value,d.shippingAddress=JSON.stringify(c.shippingAddress)),d.paymentMethod=c.selectedPaymentMethod&&c.selectedPaymentMethod.method?c.selectedPaymentMethod.method:c.selectedPaymentMethod,c.selectedShippingMethod&&c.selectedShippingMethod.method&&(d.shippingMethod=c.selectedShippingMethod.method),d.quote=JSON.stringify(m.createQuoteData()),c.payone&&c.payone.pseudocardpan&&c.payone.truncatedcardpan&&(d.payonePseudocardpan=c.payone.pseudocardpan,d.payoneTruncatedcardpan=c.payone.truncatedcardpan);var g=e.getActiveCoupons().map(function(a){return a.code});return d.coupons=JSON.stringify(g),d};m.getCleanCheckoutModel=function(){return{billingAddress:{},shippingAddress:{},payment:{},shipping:{}}},m.getPaymentBackendModel=function(a,b){return{methodCode:a,methodDetails:b,successUrl:g.get("checkoutSuccessUrl"),errorUrl:g.get("checkoutErrorUrl")}},m.getShippingBackendModel=function(a){return{methodCode:a}},m.getLastUsedPaymentMethod=function(){return j||null},m.getLastUsedShippingMethod=function(){return k||null},m.getShippingMethodsForPayPal=function(a){var b={billingAddress:{country:a||g.getDefaultCountry()},shippingAddress:{country:a||g.getDefaultCountry()},selectedPaymentMethod:"paypal_express"};return m.getSupportedCheckoutMethods(b)},m.getSupportedCheckoutMethods=function(b){var e=t(b);return e.task="GETPAYMENTMETHODS",a.Util.isObject(b.selectedPaymentMethod)&&(j=b.selectedPaymentMethod),a.Util.isObject(b.selectedShippingMethod)&&(k=b.selectedShippingMethod),c({method:"POST",url:p,headers:n,transformRequest:cc.Util.toFormData,data:e}).then(function(b){var c=null;return b.data&&(c=a.Util.toJson(b.data),c&&(c.paymentMethods=c.paymentMethods.map(function(a){return a.surcharge=parseFloat(a.surcharge),a.surcharge_percentage&&(a.surcharge_percentage=parseFloat(a.surcharge_percentage)),a}),c.shippingMethods=c.shippingMethods.map(function(a){return a.price=parseFloat(a.price),a}))),c},function(a){return f.error(["[CheckoutService: getSupportedCheckoutMethods]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})};var u=function(){var a=d.defer(),b=document.createElement("script");b.type="text/javascript",b.async=!0,b.src="https://assets.braintreegateway.com/v2/braintree.js",b.onload=function(){a.resolve()};var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(b,c),a.promise},v=function(a,b){var c=d.defer(),e=new window.braintree.api.Client({clientToken:a});return e.tokenizeCard({number:b.number,expirationMonth:b.expirationMonth,expirationYear:b.expirationYear,cvv:b.cvv},function(a,b){a?c.reject(a):c.resolve(b)}),c.promise};m.checkoutWithCouchCommerce=function(b){b.addressEqual&&(b.shippingAddress=b.billingAddress);var e=t(b);return e.task="CHECKOUT",d.when().then(function(){return"braintree_creditcard"===b.selectedPaymentMethod.method?c({method:"POST",headers:n,url:p,transformRequest:cc.Util.toFormData,data:{task:"BRAINTREETOKEN"}}).then(function(a){var b=a.data.token;return window.braintree?d.when(b):u().then(function(){return d.when(b)})}).then(function(a){return v(a,{number:b.braintree.creditcardnumber.replace(/ /g,""),cvv:b.braintree.creditcardcvc2,expirationMonth:b.braintree.creditcardexpirationmonth.value,expirationYear:2e3+b.braintree.creditcardexpirationyear.value}).then(function(a){e.braintreeNonce=a})}):d.when()}).then(function(){return c({method:"POST",url:p,headers:n,transformRequest:cc.Util.toFormData,data:e})}).then(function(b){var c=null;return b.data&&(c=a.Util.toJson(b.data),c=c.token||null),c},function(a){return f.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})},m.checkoutWithPayPal=function(a,b){var e={selectedShippingMethod:a,selectedPaymentMethod:{method:"paypal"},shippingAddress:{country:b},billingAddress:{country:b}},h=t(e);return h.task="UPDATEQUOTEPP",c({method:"POST",url:p,headers:n,transformRequest:cc.Util.toFormData,data:h}).then(function(a){return 1!=a.data?d.reject(new Error("invalid server response")):void(window.location.href=g.get("checkoutUrl"))}).then(null,function(a){return f.error(["[CheckoutService: checkoutWithPayPal]","[Request Data]",h,"[Service answer]",a]),d.reject(a)})};var w=function(a){return a===b||null===a?"":a},x=function(a){a=a||{};var b={value:w(a.country),label:w(a.countryname)};return{company:w(a.company),salutation:w(a.salutation),surname:w(a.lastname),name:w(a.firstname),street:w(a.street),streetnumber:w(a.streetnumber),streetextra:w(a.streetextra),zip:w(a.zip),city:w(a.city),country:b.value?b:null,email:w(a.email),telephone:w(a.telephone)}},y=function(a){return a=a||{},{sum:w(a.subtotal),shipping:w(a.shipping),surcharge:w(a.surcharge),vat:w(a.vat),total:w(a.grandtotal)}};return m.getSummary=function(b){return c({method:"POST",url:o+"summaryst.php",headers:n,transformRequest:cc.Util.toFormData,data:{details:"get",token:b}}).then(function(c){var d={};return d.response=a.Util.toJson(c.data),d.invoiceAddress=x(d.response.billing),d.shippingAddress=x(d.response.shipping),d.summary=y(d.response.totals),d.token=b,l=d,s=d.response.redirect?{token:b,redirect:d.response.redirect}:null,d})},m.getLastSummary=function(){return l},m.activateOrder=function(b){if(s&&s.token===b)return void(window.location.href=g.get("checkoutUrl")+s.redirect+"?token="+b);var e="PAYONE_CREDIT_CARD"===l.response.paymentMethodName,h=e?g.get("checkoutUrlNew")+"orders":o+"docheckoutst.php";return c({method:"POST",url:h,headers:n,transformRequest:cc.Util.toFormData,data:{details:"get",token:b,storeCode:g.get("storeCode")}}).then(function(b){if(e)return b.data.error?d.reject(b.data.error):b.data.redirectUrl?void(window.location.href=b.data.redirectUrl):b.data;var c=a.Util.toJson(b.data);return c},function(a){return f.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})},m.hasExistingBillingAddress=function(){return i.hasExistingBillingAddress()},m.getShippingAddress=function(){return i.getShippingAddress()},m.updateShippingAddress=function(a){i.updateShippingAddress(a)},m.getBillingAddress=function(){return i.getBillingAddress()},m.updateBillingAddress=function(a){i.updateBillingAddress(a)},m.getPaymentMethod=function(){return h.get(q)},m.updatePaymentMethod=function(a){h.set(q,a)},m.getShippingMethod=function(){return h.get(r)},m.updateShippingMethod=function(a){h.set(r,a)},m.getPaymentMethodByCode=function(b,c){return a.Util.find(c,function(a){return a.code&&a.code===b})||{}},m}),a.define("sofa.utils.FormatUtils",{zeroFill:function(a,b){return b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""}})}(sofa);