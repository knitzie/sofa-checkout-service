/**
 * sofa-checkout-service - v0.6.0 - 2014-11-05
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.CheckoutService",function(c,d,e,f,g){var h,i,j,k={},l={"Content-Type":"application/x-www-form-urlencoded"},m=g.get("checkoutUrl"),n=g.get("checkoutUrl")+"ajax.php",o=null;a.observable.mixin(k),k.createQuoteData=function(){var a=e.getItems().map(function(a){return{productID:a.product.id+"",qty:a.quantity,variantID:a.getVariantID(),optionID:a.getOptionID()}});return a};var p=function(b){if(!b)return null;var c=a.Util.clone(b);c.addressEqual&&(c.shippingAddress=a.Util.clone(c.billingAddress));var d={},f=function(b){b&&b.birthday&&b.birthmonth&&b.birthyear&&(b.birthdate=a.utils.FormatUtils.zeroFill(b.birthyear,4)+"-"+a.utils.FormatUtils.zeroFill(b.birthmonth,2)+"-"+a.utils.FormatUtils.zeroFill(b.birthday,2),delete b.birthday,delete b.birthmonth,delete b.birthyear)};f(c.billingAddress),f(c.shippingAddress),c.billingAddress&&c.billingAddress.country&&(c.billingAddress.countryLabel=c.billingAddress.country.label,c.billingAddress.country=c.billingAddress.country.value,d.invoiceAddress=JSON.stringify(c.billingAddress)),c.shippingAddress&&c.shippingAddress.country&&(c.shippingAddress.countryLabel=c.shippingAddress.country.label,c.shippingAddress.country=c.shippingAddress.country.value,d.shippingAddress=JSON.stringify(c.shippingAddress)),d.paymentMethod=c.selectedPaymentMethod&&c.selectedPaymentMethod.method?c.selectedPaymentMethod.method:c.selectedPaymentMethod,c.selectedShippingMethod&&c.selectedShippingMethod.method&&(d.shippingMethod=c.selectedShippingMethod.method),d.quote=JSON.stringify(k.createQuoteData()),c.payone&&c.payone.pseudocardpan&&c.payone.truncatedcardpan&&(d.payonePseudocardpan=c.payone.pseudocardpan,d.payoneTruncatedcardpan=c.payone.truncatedcardpan);var g=e.getActiveCoupons().map(function(a){return a.code});return d.coupons=JSON.stringify(g),d};k.getLastUsedPaymentMethod=function(){return h||null},k.getLastUsedShippingMethod=function(){return i||null},k.getShippingMethodsForPayPal=function(a){var b={billingAddress:{country:a||g.getDefaultCountry()},shippingAddress:{country:a||g.getDefaultCountry()},selectedPaymentMethod:"paypal_express"};return k.getSupportedCheckoutMethods(b)},k.getSupportedCheckoutMethods=function(b){var e=p(b);return e.task="GETPAYMENTMETHODS",a.Util.isObject(b.selectedPaymentMethod)&&(h=b.selectedPaymentMethod),a.Util.isObject(b.selectedShippingMethod)&&(i=b.selectedShippingMethod),c({method:"POST",url:n,headers:l,transformRequest:cc.Util.toFormData,data:e}).then(function(b){var c=null;return b.data&&(c=a.Util.toJson(b.data),c&&(c.paymentMethods=c.paymentMethods.map(function(a){return a.surcharge=parseFloat(a.surcharge),a.surcharge_percentage&&(a.surcharge_percentage=parseFloat(a.surcharge_percentage)),a}),c.shippingMethods=c.shippingMethods.map(function(a){return a.price=parseFloat(a.price),a}))),c},function(a){return f.error(["[CheckoutService: getSupportedCheckoutMethods]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})};var q=function(){var a=d.defer(),b=document.createElement("script");b.type="text/javascript",b.async=!0,b.src="https://assets.braintreegateway.com/v2/braintree.js",b.onload=function(){a.resolve()};var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(b,c),a.promise},r=function(a,b){var c=d.defer(),e=new window.braintree.api.Client({clientToken:a});return e.tokenizeCard({number:b.number,expirationMonth:b.expirationMonth,expirationYear:b.expirationYear,cvv:b.cvv},function(a,b){a?c.reject(a):c.resolve(b)}),c.promise};k.checkoutWithCouchCommerce=function(b){b.addressEqual&&(b.shippingAddress=b.billingAddress);var e=p(b);return e.task="CHECKOUT",d.when().then(function(){return"braintree_creditcard"===b.selectedPaymentMethod.method?c({method:"POST",headers:l,url:n,transformRequest:cc.Util.toFormData,data:{task:"BRAINTREETOKEN"}}).then(function(a){var b=a.data.token;return window.braintree?d.when(b):q().then(function(){return d.when(b)})}).then(function(a){return r(a,{number:b.braintree.creditcardnumber.replace(/ /g,""),cvv:b.braintree.creditcardcvc2,expirationMonth:b.braintree.creditcardexpirationmonth.value,expirationYear:2e3+b.braintree.creditcardexpirationyear.value}).then(function(a){e.braintreeNonce=a})}):d.when()}).then(function(){return c({method:"POST",url:n,headers:l,transformRequest:cc.Util.toFormData,data:e})}).then(function(b){var c=null;return b.data&&(c=a.Util.toJson(b.data),c=c.token||null),c},function(a){return f.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})},k.checkoutWithPayPal=function(a,b){var e={selectedShippingMethod:a,selectedPaymentMethod:{method:"paypal"},shippingAddress:{country:b},billingAddress:{country:b}},h=p(e);return h.task="UPDATEQUOTEPP",c({method:"POST",url:n,headers:l,transformRequest:cc.Util.toFormData,data:h}).then(function(a){return 1!=a.data?d.reject(new Error("invalid server response")):void(window.location.href=g.get("checkoutUrl"))}).then(null,function(a){return f.error(["[CheckoutService: checkoutWithPayPal]","[Request Data]",h,"[Service answer]",a]),d.reject(a)})};var s=function(a){return a===b||null===a?"":a},t=function(a){a=a||{};var b={value:s(a.country),label:s(a.countryname)};return{company:s(a.company),salutation:s(a.salutation),surname:s(a.lastname),name:s(a.firstname),street:s(a.street),streetnumber:s(a.streetnumber),streetextra:s(a.streetextra),zip:s(a.zip),city:s(a.city),country:b.value?b:null,email:s(a.email),telephone:s(a.telephone)}},u=function(a){return a=a||{},{sum:s(a.subtotal),shipping:s(a.shipping),surcharge:s(a.surcharge),vat:s(a.vat),total:s(a.grandtotal)}};return k.getSummary=function(b){return c({method:"POST",url:m+"summaryst.php",headers:l,transformRequest:cc.Util.toFormData,data:{details:"get",token:b}}).then(function(c){var d={};return d.response=a.Util.toJson(c.data),d.invoiceAddress=t(d.response.billing),d.shippingAddress=t(d.response.shipping),d.summary=u(d.response.totals),d.token=b,j=d,o=d.response.redirect?{token:b,redirect:d.response.redirect}:null,d})},k.getLastSummary=function(){return j},k.activateOrder=function(b){if(o&&o.token===b)return void(window.location.href=g.get("checkoutUrl")+o.redirect+"?token="+b);var e="PAYONE_CREDIT_CARD"===j.response.paymentMethodName,h=e?g.get("checkoutUrlNew")+"orders":m+"docheckoutst.php";return c({method:"POST",url:h,headers:l,transformRequest:cc.Util.toFormData,data:{details:"get",token:b,storeCode:g.get("storeCode")}}).then(function(b){if(e)return b.data.error?d.reject(b.data.error):b.data.redirectUrl?void(window.location.href=b.data.redirectUrl):b.data;var c=a.Util.toJson(b.data);return c},function(a){return f.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",b,"[Service answer]",a]),d.reject(a)})},k}),a.define("sofa.utils.FormatUtils",{zeroFill:function(a,b){return b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""}})}(sofa);